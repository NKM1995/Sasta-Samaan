import React, { useEffect, useState, useMemo } from 'react';
import api from '../api';
import ProductCard from '../components/ProductCard';
import SearchBar from '../components/SearchBar';

/**
 * Home.jsx
 * - fetches flat provider-specific listings from backend /products
 * - groups them by product_id or normalized name into product objects with listings[]
 * - renders provider filter controls so you can toggle which providers to show
 */

function normalizeKey(item) {
  if (item.product_id) return String(item.product_id);
  if (item.name) return item.name.trim().toLowerCase();
  return String(item.listing_id || Math.random()).trim();
}

export default function Home() {
  const [q, setQ] = useState('');
  const [productsRaw, setProductsRaw] = useState([]);
  const [loading, setLoading] = useState(true);
  const [providerFilter, setProviderFilter] = useState({}); // { Zepto: true, Blinkit: true, ... }

  async function fetchProducts() {
    setLoading(true);
    try {
      const params = {};
      if (q) params.q = q;
      const res = await api.get('/products', { params });
      const flat = Array.isArray(res.data) ? res.data : [];
      setProductsRaw(flat);
      // derive providers present and initialize filter (if empty)
      const provs = Array.from(new Set(flat.map(x => x.provider).filter(Boolean)));
      setProviderFilter(prev => {
        // keep existing choices for providers we know; default new ones to true
        const next = {};
        provs.forEach(p => { next[p] = prev.hasOwnProperty(p) ? prev[p] : true; });
        return next;
      });
    } catch (e) {
      console.error('fetchProducts error', e);
      setProductsRaw([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => { fetchProducts(); }, []);

  // grouped products: memoized so re-renders are cheap
  const grouped = useMemo(() => {
    const map = {};
    productsRaw.forEach(item => {
      const key = normalizeKey(item);
      if (!map[key]) {
        map[key] = {
          product_id: item.product_id || key,
          name: item.name || (item.raw && item.raw.name) || 'Unknown',
          brand: item.brand || '',
          unit: item.unit || '',
          listings: []
        };
      }
      map[key].listings.push({
        listing_id: item.listing_id ?? item.id ?? null,
        provider: item.provider || 'Unknown',
        price: item.price,
        unit: item.unit,
        normalized_price: item.normalized_price ?? null,
        normalized_unit: item.normalized_unit ?? null,
        fetched_at: item.fetched_at ?? null,
        link: item.url ?? item.link ?? null,
        raw: item
      });
    });
    return Object.values(map);
  }, [productsRaw]);

  // get sorted provider list for UI controls
  const providers = useMemo(() => {
    const s = new Set();
    productsRaw.forEach(p => { if (p.provider) s.add(p.provider); });
    return Array.from(s).sort();
  }, [productsRaw]);

  function toggleProvider(provider) {
    setProviderFilter(prev => ({ ...prev, [provider]: !prev[provider] }));
  }

  // when rendering cards, pass a product object with filtered listings only
  const filteredProducts = useMemo(() => {
    return grouped.map(prod => ({
      ...prod,
      listings: prod.listings.filter(l => providerFilter[l.provider])
    })).filter(p => p.listings.length > 0); // hide products with zero visible providers
  }, [grouped, providerFilter]);

  return (
    <div className="app-container" style={{ paddingTop: 8 }}>
      <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', gap:12, marginBottom:12 }}>
        <div style={{ display:'flex', gap:12, alignItems:'center' }}>
          <div style={{ fontWeight:700, fontSize:20 }}>Sasta-Samaan</div>
          <div style={{ color:'#6b7280' }}>Price compare MVP</div>
        </div>

        <div style={{ display:'flex', gap:8, alignItems:'center' }}>
          <div style={{ display:'flex', gap:8, alignItems:'center' }}>
            <SearchBar value={q} onChange={setQ} onEnter={fetchProducts} />
            <button onClick={fetchProducts} style={{ padding:'8px 10px', borderRadius:8 }}>Search</button>
          </div>
        </div>
      </div>

      <div style={{ display:'flex', gap:16, marginBottom:12, alignItems:'center', flexWrap:'wrap' }}>
        <div style={{ fontWeight:700 }}>Providers</div>
        {providers.length === 0 ? <div style={{ color:'#9ca3af' }}>No providers</div> : providers.map(p => (
          <label key={p} style={{ display:'inline-flex', alignItems:'center', gap:8, cursor:'pointer', userSelect:'none' }}>
            <input type="checkbox" checked={!!providerFilter[p]} onChange={() => toggleProvider(p)} />
            <span style={{ fontSize:14 }}>{p}</span>
          </label>
        ))}
        <button onClick={() => {
          // quick helpers
          const all = {};
          providers.forEach(p => all[p] = true);
          setProviderFilter(all);
        }} style={{ marginLeft:12 }}>Select all</button>
        <button onClick={() => {
          const none = {};
          providers.forEach(p => none[p] = false);
          setProviderFilter(none);
        }}>Clear</button>
      </div>

      {loading ? <div>Loading products...</div> : (
        <div className="product-grid" style={{ marginBottom: 32 }}>
          {filteredProducts.map(p => <ProductCard key={p.product_id || p.name} product={p} />)}
        </div>
      )}
    </div>
  );
}
