import React, { useState } from 'react';
import { addToCart, loadCarts, removeFromCart } from '../utils/cartUtils';

/**
 * ProductCard - dispatches toast on add with Undo support.
 * Undo will remove the product from the provider cart (last added product payload).
 */

export default function ProductCard({ product }){
  const [addedMap, setAddedMap] = useState(()=>{
    const carts = loadCarts();
    const map = {};
    Object.keys(carts).forEach(key => (carts[key] || []).forEach(it => { if (String(it.product_id) === String(product.product_id || product.name)) map[key] = true; }));
    return map;
  });

  const listings = (product.listings || []).slice();
  let cheapest = null;
  listings.forEach(l=>{
    const p = Number(l.price);
    if (!isNaN(p) && (cheapest === null || p < Number(cheapest.price))) cheapest = l;
  });

  function providerKey(provider){ return provider.toLowerCase().replace(/\s+/g,''); }

  function handleAdd(listing){
    const key = providerKey(listing.provider);
    const item = {
      product_id: product.product_id || product.name,
      name: product.name,
      price: listing.price,
      provider: listing.provider,
      link: listing.link || (listing.raw && listing.raw.url) || '#'
    };
    addToCart(key, item);
    setAddedMap(prev => ({ ...prev, [key]: true }));
    try { window.dispatchEvent(new CustomEvent('sasta:cart:changed')); } catch(e){}
    // dispatch toast with Undo action
    const message = `${product.name} added to ${listing.provider} cart`;
    const payload = { providerKey: key, product_id: item.product_id };
    window.dispatchEvent(new CustomEvent('sasta:toast', { detail: { message, actionText: 'Undo', payload } }));
    // register undo handler (overwrites previous; simple semantics)
    window.sastaUndo = function(payload) {
      try {
        removeFromCart(payload.providerKey, payload.product_id);
        window.dispatchEvent(new CustomEvent('sasta:cart:changed'));
      } catch (e) { console.warn('undo failed', e); }
    };
  }

  return (
    <article className="card" aria-label={product.name}>
      <div>
        <div className="title">{product.name}</div>
        <div className="meta">{product.brand}{product.unit ? ` â€¢ ${product.unit}` : ''}</div>
      </div>

      <div style={{marginTop:10}}>
        {(listings || []).map(listing => {
          const isCheapest = cheapest && String(listing.provider) === String(cheapest.provider) && Number(listing.price) === Number(cheapest.price);
          const key = providerKey(listing.provider);
          const isAdded = !!addedMap[key];
          return (
            <div key={String(listing.listing_id || listing.provider)} className={`provider-row ${isCheapest ? 'cheapest' : ''}`}>
              <div className="provider-left">
                <div className="provider-name">{listing.provider}</div>
                <div className="provider-meta">{listing.unit ? `${listing.unit} â€¢ ` : ''}{listing.fetched_at ? new Date(listing.fetched_at).toLocaleDateString() : ''}</div>
              </div>

              <div style={{display:'flex',alignItems:'center',gap:12}}>
                <div style={{textAlign:'right',minWidth:72}}>
                  <div className="provider-price">â‚¹{listing.price}</div>
                  {listing.normalized_price ? <div style={{fontSize:12,color:'var(--accent)'}}>â‚¹{listing.normalized_price} / {listing.normalized_unit === 'per_100g' ? '100g' : '100ml'}</div> : null}
                </div>

                <button
                  className="cart-btn"
                  disabled={isAdded}
                  title={isAdded ? 'Already in cart' : `Add to ${listing.provider} cart`}
                  aria-label={isAdded ? 'Already in cart' : `Add to ${listing.provider} cart`}
                  onClick={() => handleAdd(listing)}
                >
                  ðŸ›’
                </button>
              </div>
            </div>
          );
        })}
      </div>
    </article>
  );
}
