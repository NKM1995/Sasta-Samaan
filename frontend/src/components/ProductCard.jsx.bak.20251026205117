import React, { useState } from 'react';
import { addToCart, loadCarts } from '../utils/cartUtils';

/**
 * Compact ProductCard showing multiple provider rows.
 * Highlights cheapest provider row only.
 * Uses a small cart icon button (ðŸ›’) for Add-to-Cart actions.
 */

export default function ProductCard({ product }) {
  const [addedMap, setAddedMap] = useState(() => {
    const carts = loadCarts();
    const map = {};
    Object.keys(carts).forEach(key => {
      (carts[key] || []).forEach(item => {
        if (String(item.product_id) === String(product.product_id || product.name)) {
          map[key] = true;
        }
      });
    });
    return map;
  });

  const listings = (product.listings || []).slice();
  // compute cheapest by numeric price (guard NaN)
  let cheapest = null;
  listings.forEach(l => {
    const p = Number(l.price);
    if (!isNaN(p) && (cheapest === null || p < Number(cheapest.price))) cheapest = l;
  });

  function providerKey(provider) {
    return provider.toLowerCase().replace(/\s+/g, '');
  }

  function handleAdd(listing) {
    const key = providerKey(listing.provider);
    const item = {
      product_id: product.product_id || product.name,
      name: product.name,
      price: listing.price,
      provider: listing.provider,
      link: listing.link || (listing.raw && listing.raw.url) || '#'
    };
    addToCart(key, item);
    setAddedMap(prev => ({ ...prev, [key]: true }));
    try { window.dispatchEvent(new CustomEvent('sasta:cart:changed')); } catch(e) {}
  }

  return (
    <div className="card" role="article" aria-label={product.name}>
      <div>
        <div className="title">{product.name}</div>
        <div className="meta">{product.brand} â€¢ {product.unit}</div>
      </div>

      <div style={{marginTop:12}}>
        {listings.map(listing => {
          const isCheapest = cheapest && String(listing.provider) === String(cheapest.provider) && Number(listing.price) === Number(cheapest.price);
          const key = providerKey(listing.provider);
          const isAdded = !!addedMap[key];
          return (
            <div key={listing.provider} className={`provider-row ${isCheapest ? 'cheapest' : ''}`}>
              <div className="provider-left">
                <div className="provider-name">{listing.provider}</div>
                <div className="provider-meta"> {listing.unit ? `${listing.unit} â€¢ ` : ''}{listing.fetched_at ? new Date(listing.fetched_at).toLocaleDateString() : ''}</div>
              </div>
              <div style={{display:'flex', alignItems:'center', gap:10}}>
                <div style={{textAlign:'right', minWidth:72}}>
                  <div className="provider-price">â‚¹{listing.price}</div>
                  {listing.normalized_price ? <div style={{fontSize:12, color:'#0b69ff'}}>â‚¹{listing.normalized_price} / {listing.normalized_unit === 'per_100g' ? '100g' : '100ml'}</div> : null}
                </div>

                <button
                  className="cart-btn"
                  disabled={isAdded}
                  title={isAdded ? 'Already in cart' : `Add to ${listing.provider} cart`}
                  aria-label={isAdded ? 'Already in cart' : `Add to ${listing.provider} cart`}
                  onClick={() => handleAdd(listing)}
                >
                  ðŸ›’
                </button>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}
